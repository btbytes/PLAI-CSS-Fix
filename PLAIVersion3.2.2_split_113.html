<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Unknown</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="page_styles.css"/>
</head>
  <body class="c">
<h2 class="c27" id="h.stnwipd5np0c"><span class="c4">Generic Printing</span></h2><p class="c3"><span class="c4"></span></p><p class="c5"><span class="calibre3">One of the consequences of our tagged representation is that when extracting a value from memory, we don’t </span><span class="c7">have</span><span class="calibre3"> to know whether to use </span><span class="c28">safe-read-num</span><span class="calibre3"> or </span><span class="c28">safe-read-str</span><span class="c4">; the tag at the address can tell us which to use. That is, we can define</span></p><p class="c3"><span class="c4"></span></p><p class="c5"><span class="c41">(define (generic-read a)</span></p><p class="c5"><span class="c41">  (let ([tag (vector-ref MEMORY a)])</span></p><p class="c5"><span class="c41">    (cond</span></p><p class="c5"><span class="c41">      [(= tag NUMBER-TAG) (safe-read-num a)]</span></p><p class="c5"><span class="c41">      [(= tag STRING-TAG) (safe-read-str a)]</span></p><p class="c5"><span class="c41">      [else (error 'generic-print "invalid tag")])))</span></p><p class="c3"><span class="c4"></span></p><p class="c5"><span class="c4">Unfortunately, this code can’t be typed by plait because the two branches return different types. We can solve this in two ways:</span></p><p class="c3"><span class="c4"></span></p><ol class="c105" start="1"><li class="c106 pcalibre15"><span class="calibre3">We can use a hack: use </span><span class="c28">#lang plait #:untyped</span><span class="calibre3">, which provides the same syntactic language, features, and run-time behavior, but turns off the type-checker. (Curiously, we were using the type-checker to keep us disciplined: so that the only values we could store in </span><span class="c28">MEMORY</span><span class="c4"> would be numbers! Therefore, it’s good to not use the untyped version often.)</span></li><li class="c106 pcalibre15"><span class="calibre3">Notice that in the end, what printers do is essentially print a string. Therefore, we just need to return a string in all cases:<br class="calibre"/><br class="calibre"/></span><span class="c41">(define (generic-read a)</span></li></ol><p class="c31"><span class="c41">  (let ([tag (vector-ref MEMORY a)])</span></p><p class="c31"><span class="c41">    (cond</span></p><p class="c31"><span class="c41">      [(= tag NUMBER-TAG) (number-&gt;string (safe-read-num a))]</span></p><p class="c31"><span class="c41">      [(= tag STRING-TAG) (safe-read-str a)]</span></p><p class="c31"><span class="c41">      [else (error 'generic-print "invalid tag")])))</span></p><p class="c3"><span class="c4"></span></p><p class="c5"><span class="c4">A consequence of having this function is that we can rewrite our tests to be more proper:</span></p><p class="c3"><span class="c4"></span></p><p class="c5"><span class="c41">(test (generic-read (calc (plus (num 1) (num 2)))) "3")</span></p><p class="c5"><span class="c41">(test (generic-read (calc (plus (num 1) (plus (num 2) (num 3))))) "6")</span></p><p class="c5"><span class="c41">(test (generic-read (calc (cat (str "hel") (str "lo")))) "hello")</span></p><p class="c5"><span class="c41">(test (generic-read (calc (cat (cat (str "hel") (str "l")) (str "o")))) "hello")</span></p><p class="c3"><span class="c41"></span></p><p class="c5"><span class="calibre3">This is much closer to how we would write the test in the original interpreter; the only difference here is that the evaluator produces an address as the value, but we would like to inspect the value in a human-readable and -writable form, so we use </span><span class="c28">generic-read</span><span class="c4">.</span></p><p class="c3"><span class="c4"></span></p><p class="c31"><span class="c40">Alert:</span><span class="calibre3"> If you run these tests in addition to the preceding ones, you may need to enlarge </span><span class="c28">MEMORY</span><span class="c4">.</span></p><a id="kix.3i7vvizaw4m8"></a></body></html>
